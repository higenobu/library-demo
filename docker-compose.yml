version: "3.9"
services:
  db:
    image: postgres:15
    environment:
      POSTGRES_USER: matsuo
      POSTGRES_PASSWORD: masanobu
      POSTGRES_DB: emr_sample
    volumes:
      - db_data:/var/lib/postgresql/data
    healthcheck:
      test: ["CMD-SHELL", "pg_isready -U matsuo -d emr_sample"]
      interval: 5s
      timeout: 5s
      retries: 12

  web:
    build: .
    depends_on:
      db:
        condition: service_healthy
    environment:
      # Web コンテナに正しい DB 接続文字列を渡す（ホスト名は db）
      DATABASE_URL: "postgresql://matsuo:masanobu@db:5432/emr_sample"
      # もし app.py が別の変数名を使っているならそれも追加可能
      # DB_HOST: db
      # DB_PORT: "5432"
    ports:
      - "8050:8050"
    # volumes:  # 開発時にホストマウントする場合はホスト側に app.py/run.sh を置くこと
    restart: unless-stopped

volumes:
  db_data:
